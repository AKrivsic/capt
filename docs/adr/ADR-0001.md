# ADR-0001: BullMQ Queue System for Video Processing

## Status
Accepted

## Context
Captioni potřebuje asynchronní zpracování video souborů pro generování titulků. Video processing je výpočetně náročný proces, který zahrnuje:
- Stahování videa z R2 storage
- Transkripci audio přes OpenAI Whisper
- Rendering titulků přes FFmpeg
- Upload výsledku zpět do R2

Synchronní zpracování by blokovalo API requests a vedlo by k timeoutům. Potřebujeme robustní queue systém pro background processing.

## Decision
Použijeme BullMQ jako queue systém pro asynchronní zpracování video jobů.

### Implementace:
- **Queue Provider**: BullMQ s Redis jako storage
- **Redis Hosting**: Upstash Redis (managed service)
- **Worker Process**: Dedicated Vercel Function nebo separátní proces
- **Job Retry**: 3 pokusy s exponential backoff
- **Job Persistence**: 500 completed, 1000 failed jobs

### Architektura:
```
API Request → Job Creation → BullMQ Queue → Worker Process → Result Storage
```

## Consequences

### Positive:
- Asynchronní zpracování bez blokování API
- Robustní error handling a retry mechanismus
- Monitoring a observability jobů
- Škálovatelnost podle workload

### Negative:
- Dodatečná komplexita systému
- Závislost na Redis/Upstash
- Potřeba worker procesů
- Latence v job processing

### Risks:
- Redis outage by zastavil queue
- Worker failures by vedly k nedokončeným jobům
- Queue backlog při vysokém load

## Alternatives Considered

### 1. Vercel Serverless Functions
**Rejected**: 10s timeout limit není dostatečný pro video processing

### 2. Direct Processing v API Route
**Rejected**: Blokuje API requests a vede k timeoutům

### 3. AWS SQS + Lambda
**Rejected**: Větší komplexita a náklady pro Next.js stack

### 4. In-memory Queue
**Rejected**: Neškáluje a ztrácí joby při restartu

### 5. Database-based Queue
**Rejected**: PostgreSQL není optimalizovaný pro queue operations

## Implementation Notes

### Queue Configuration:
```typescript
const queue = new Queue('subtitles', {
  connection: redis,
  defaultJobOptions: {
    removeOnComplete: 500,
    removeOnFail: 1000,
    attempts: 3,
    backoff: { type: 'exponential', delay: 2000 }
  }
});
```

### Worker Setup:
```typescript
const worker = new Worker('subtitles', processor, {
  connection: redis,
  concurrency: 4
});
```

### Dependencies:
- `bullmq`: Queue management
- `ioredis`: Redis client
- `upstash`: Redis hosting

## References
- [BullMQ Documentation](https://docs.bullmq.io/)
- [Upstash Redis](https://upstash.com/)
- [Vercel Functions Limits](https://vercel.com/docs/concepts/functions/serverless-functions)
